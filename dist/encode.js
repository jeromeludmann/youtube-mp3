'use strict';Object.defineProperty(exports,'__esModule',{value:true});var _promise=require('babel-runtime/core-js/promise');var _promise2=_interopRequireDefault(_promise);exports.encodeToMp3=encodeToMp3;var _fs=require('fs');var _fs2=_interopRequireDefault(_fs);var _path=require('path');var _path2=_interopRequireDefault(_path);var _child_process=require('child_process');function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}var DEFAULT_QUALITY='320k';var METADATA_ARGS={'opus':'0:s:0','m4a':'0','ogg':'0:s:0'};function encodeToMp3(_ref,callback){var key=_ref.key,sourceFile=_ref.sourceFile,quality=_ref.quality,_ref$slice=_ref.slice,slice=_ref$slice===undefined?{tags:{}}:_ref$slice,target=_ref.target,_ref$withTrackNumber=_ref.withTrackNumber,withTrackNumber=_ref$withTrackNumber===undefined?true:_ref$withTrackNumber,_ref$verbose=_ref.verbose,verbose=_ref$verbose===undefined?false:_ref$verbose;return new _promise2.default(function(resolve,reject){if(!_fs2.default.existsSync(target)){_fs2.default.mkdirSync(target)}var args=getArguments(key,sourceFile,quality,slice,withTrackNumber,verbose);var filename=_path2.default.resolve(target,generateFilename(key,slice,withTrackNumber));args.push(filename);var ffmpeg=(0,_child_process.spawn)('ffmpeg',args);var onData=function onData(data){callback(key,data.toString())};var onClose=function onClose(code){if(code!==0){console.error('Error while encoding Youtube video ID: '+key)}resolve(filename)};ffmpeg.stdout.on('data',onData);ffmpeg.stderr.on('data',onData);ffmpeg.on('close',onClose)})}function getArguments(key,sourceFile,quality,slice,withTrackNumber,verbose){var ffmpegArgs=['-loglevel',verbose?'debug':'info','-i',sourceFile,'-vn','-sn','-y','-c:a','mp3'];var extension=sourceFile.slice(sourceFile.lastIndexOf('.')+1);var metadataArg=METADATA_ARGS[extension];if(!metadataArg){throw new Error('file extension '+extension+' not found in metadata args')}ffmpegArgs.push('-map_metadata',metadataArg);ffmpegArgs.push('-b:a',quality?quality:DEFAULT_QUALITY);if(withTrackNumber&&slice.tags.track){ffmpegArgs.push('-metadata','track='+slice.tags.track)}if(slice.tags.title){ffmpegArgs.push('-metadata','title='+slice.tags.title)}if(slice.tags.artist){ffmpegArgs.push('-metadata','artist='+slice.tags.artist)}if(slice.tags.album){ffmpegArgs.push('-metadata','album='+slice.tags.album)}if(slice.start){ffmpegArgs.push('-ss',slice.start.trim())}if(slice.end){ffmpegArgs.push('-to',slice.end.trim())}if(slice.duration){ffmpegArgs.push('-t',slice.duration.trim())}return ffmpegArgs}function generateFilename(key,slice,withTrackNumber){if(!slice.tags){slice.tags={}}if(!slice.start){slice.start='00:00:00'}var filename=[];if(withTrackNumber&&slice.tags.track){filename.push(('0'+slice.tags.track).slice(-2))}if(slice.tags.artist){filename.push(slice.tags.artist)}else{filename.push('youtube_'+key)}if(slice.tags.title){filename.push(slice.tags.title)}else{filename.push(slice.start.replace(/:/g,''))}return filename.join(' - ').replace(/\//,'\u2044')+'.mp3'}